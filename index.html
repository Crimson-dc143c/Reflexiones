<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Crimson | Marea Eterna</title>

  <style>
    /* --- CONFIGURACI√ìN GLOBAL --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg-gradient: radial-gradient(circle at top, #2b0a0a, #050000);
      --text-primary: #f5eaea;
      --text-dim: rgba(245, 234, 234, 0.6);
      --crimson-glow: #ff4d4d;
      --crimson-dark: #681414;
      --crimson-bright: #e04545;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(0,0,0,0.4);
      --nav-bg: rgba(10, 0, 0, 0.95);
      
      /* Variables din√°micas para La Marea (Se actualizan con JS) */
      --c1: rgba(0, 255, 180, 0.7); 
      --c2: rgba(0, 150, 255, 0.6);
      --c3: rgba(180, 80, 255, 0.5);
      --c4: rgba(50, 255, 50, 0.6);
    }

    body.light-mode {
      --bg-gradient: linear-gradient(180deg, #f2ecec, #e6dada);
      --text-primary: #4a1212;
      --text-dim: rgba(74, 18, 18, 0.7);
      --crimson-glow: #d63030;
      --crimson-dark: #a32a2a;
      --crimson-bright: #ff2e2e;
      --glass: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(104, 20, 20, 0.15);
      --input-bg: rgba(255,255,255,0.7);
      --nav-bg: rgba(245, 240, 240, 0.95);
    }

    body {
      margin: 0; padding: 0;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.8s ease, color 0.8s ease;
      padding-bottom: 120px;
      overflow-x: hidden;
    }

    /* =========================
       SPLASH SCREEN
       ========================= */
    #splash {
      position: fixed; inset: 0;
      background: radial-gradient(circle at center, #1a0505 0%, #000 100%);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 20000;
      transition: opacity 1.5s ease, visibility 1.5s;
    }
    .lotus { position: relative; width: 180px; height: 180px; display: flex; justify-content: center; align-items: center; }
    .brand-name {
      margin-top: 40px; color: #f5eaea; font-size: 28px; letter-spacing: 8px;
      text-transform: uppercase; font-weight: 300; opacity: 0;
      animation: fadeInText 3s ease-out forwards; animation-delay: 1.2s;
      text-shadow: 0 0 15px rgba(255, 75, 75, 0.4); font-family: 'Georgia', serif;
    }
    .core {
      position: absolute; width: 20px; height: 20px; border-radius: 50%;
      background: radial-gradient(circle, #ffd2d2, #ff4b4b);
      box-shadow: 0 0 30px rgba(255, 75, 75, 0.8); z-index: 10;
      animation: breathe 3s ease-in-out infinite;
    }
    .petal {
      position: absolute; bottom: 50%; width: 35px; height: 85px;
      background: linear-gradient(to top, rgba(120, 0, 0, 0.9), rgba(255, 80, 120, 0.4));
      border-radius: 50% 50% 50% 50% / 80% 80% 20% 20%;
      transform-origin: bottom center; opacity: 0; filter: blur(0.5px);
      border: 0.5px solid rgba(255, 255, 255, 0.1);
      animation: blossom 3.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      animation-delay: calc(var(--i) * 0.1s);
    }
    .fade-out { opacity: 0; visibility: hidden; pointer-events: none; }

    @keyframes blossom { 0% { opacity: 0; transform: rotate(calc(var(--i) * 45deg)) scale(0) translateY(0); } 30% { opacity: 0.8; } 100% { opacity: 1; transform: rotate(calc(var(--i) * 45deg)) scale(1) translateY(-15px); } }
    @keyframes fadeInText { from { opacity: 0; transform: translateY(10px); filter: blur(5px); } to { opacity: 0.8; transform: translateY(0); filter: blur(0); } }
    @keyframes breathe { 0%, 100% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.15); filter: brightness(1.3); } }
    
    /* --- ANIMACIONES APP --- */
    @keyframes entry { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 46, 46, 0.5); } 70% { box-shadow: 0 0 0 15px rgba(255, 46, 46, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 46, 46, 0); } }
    @keyframes spin-moon { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }

    .item { animation: entry 0.5s cubic-bezier(0.2, 1, 0.3, 1) backwards; transition: 0.4s; }
    
    /* --- UI PRINCIPAL --- */
    .container { width: 92%; max-width: 500px; margin: 0 auto; padding: 25px 0; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { font-family: 'Georgia', serif; letter-spacing: 4px; margin: 0; text-shadow: 0 0 20px var(--crimson-glow); font-size: 1.8rem; }

    /* Bot√≥n Tema Animado */
    .theme-toggle {
        font-size: 1.4rem; display: flex; align-items: center; justify-content: center;
        width: 50px; height: 50px; border-radius: 50%; border: none;
        background: rgba(0,0,0,0.2); cursor: pointer; transition: 0.3s;
        border: 1px solid var(--glass-border);
    }
    .theme-toggle:active { transform: scale(0.9); }
    .theme-toggle.spinning { animation: spin-moon 0.8s ease-in-out; }

    .composer { background: var(--glass); padding: 22px; border-radius: 30px; margin-bottom: 30px; border: 1px solid var(--glass-border); backdrop-filter: blur(12px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    input, textarea, select {
      width: 100%; margin-bottom: 14px; padding: 15px; border-radius: 18px;
      border: 1px solid var(--glass-border); background: var(--input-bg);
      color: var(--text-primary); font-size: 16px; outline: none; transition: 0.3s; font-family: inherit;
    }
    input:focus, textarea:focus { border-color: var(--crimson-glow); box-shadow: 0 0 15px rgba(255,46,46,0.15); transform: translateY(-1px); }

    .main-btn { width: 100%; padding: 16px; border-radius: 18px; border: none; background: var(--crimson-dark); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; letter-spacing: 0.5px; }
    .main-btn:active { transform: scale(0.96); }

    /* Modal Botones */
    .modal-btn-group { display: flex; gap: 10px; width: 100%; margin-top: 15px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-edit { background: var(--glass); color: var(--text-primary); border: 1px solid var(--glass-border); }
    .btn-del { background: rgba(255,0,0,0.15); color: #ff6b6b; border: 1px solid rgba(255,0,0,0.2); }
    .btn-save { background: var(--crimson-dark); color: white; }

    .pill { white-space: nowrap; padding: 8px 18px; border-radius: 25px; background: var(--glass); border: 1px solid var(--glass-border); font-size: 0.8rem; cursor: pointer; transition: 0.3s; opacity: 0.8; }
    .pill.active { background: var(--crimson-dark); border-color: var(--crimson-bright); opacity: 1; transform: scale(1.05); }

    .mood-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 20px; margin-bottom: 15px; border: 1px solid var(--glass-border); }
    .mood-icon { font-size: 1.5rem; cursor: pointer; opacity: 0.4; transition: 0.4s; filter: grayscale(0.8); }
    .mood-icon.active { opacity: 1; transform: scale(1.3) translateY(-2px); filter: grayscale(0); text-shadow: 0 0 10px rgba(255,255,255,0.3); }

    /* --- ITEM DIARIO (LISTA) --- */
    .note-card {
        background: var(--glass); padding: 18px; border-radius: 22px; margin-bottom: 15px;
        border: 1px solid var(--glass-border); position: relative; overflow: hidden;
    }
    .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .note-date { font-size: 0.75rem; opacity: 0.5; letter-spacing: 1px; }
    .note-tags { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .note-tag { font-size: 0.7rem; padding: 3px 8px; background: rgba(255,255,255,0.05); border-radius: 8px; color: var(--crimson-bright); }
    .note-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
    .action-icon { cursor: pointer; opacity: 0.6; transition: 0.2s; font-size: 0.9rem; }
    .action-icon:hover { opacity: 1; transform: scale(1.1); }


    /* --- GALER√çA POR MESES --- */
    .month-group { margin-bottom: 35px; animation: entry 0.5s ease; }
    .month-title { 
        font-family: 'Georgia', serif; 
        font-size: 1.1rem; 
        color: var(--crimson-bright); 
        margin-bottom: 10px; 
        padding-left: 10px; 
        border-left: 3px solid var(--crimson-dark);
        opacity: 0.9;
    }
    .gallery-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px 20px 5px; scroll-snap-type: x mandatory; scrollbar-width: none; }
    .gallery-scroll::-webkit-scrollbar { display: none; }
    .gallery-card {
      flex: 0 0 auto; width: 200px; scroll-snap-align: start;
      background: var(--glass); border-radius: 22px; padding: 12px;
      border: 1px solid var(--glass-border); display: flex; flex-direction: column;
      transition: transform 0.3s ease;
      position: relative;
    }
    .gallery-card:active { transform: scale(0.97); }
    .gallery-img-box { width: 100%; aspect-ratio: 1/1; border-radius: 16px; overflow: hidden; margin-bottom: 10px; }
    .gallery-img-box img { width: 100%; height: 100%; object-fit: cover; }
    .date-link {
      font-size: 0.75rem; color: var(--crimson-bright); margin-top: 5px; 
      display: inline-block; padding: 4px 10px; background: rgba(255,0,0,0.1);
      border-radius: 12px; cursor: pointer; transition: 0.2s;
    }

    /* --- AUDIO & NAV --- */
    .rec-box { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 50px; border: 1px solid var(--glass-border); }
    .rec-btn { background: #1a1a1a; color: white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 1.1rem; transition: 0.3s; }
    .rec-btn.recording { background: var(--crimson-glow); animation: pulse-red 1.2s infinite; }
    
    .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 88%; max-width: 420px; background: var(--nav-bg); height: 75px; display: flex; justify-content: space-around; align-items: center; border-radius: 40px; border: 1px solid var(--glass-border); z-index: 1000; backdrop-filter: blur(20px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); transition: 0.4s; cursor: pointer; }
    .nav-item.active { color: var(--crimson-bright); transform: translateY(-4px); }
    .nav-item .icon { font-size: 1.4rem; margin-bottom: 2px; }

    .hidden { display: none !important; }

    /* =========================================
       MAREA (AURORA + NEBULA) REINTEGRADA
       ========================================= */
    
    #marea-visual-box {
      position: relative;
      width: 100%;
      height: 380px;
      margin: 20px 0;
      border-radius: 30px;
      overflow: hidden;
      background: radial-gradient(circle at bottom, #0d1b2a 0%, #000 80%);
      border: 1px solid var(--glass-border);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 1s ease; /* Transici√≥n suave de colores */
    }

    /* Fondo estelar contenido */
    .estrellas {
        position: absolute;
        top: -50%; left: -50%; width: 200%; height: 200%;
        background-image: 
          radial-gradient(1px 1px at 10% 20%, #fff, transparent),
          radial-gradient(1.5px 1.5px at 50% 50%, #fff, transparent),
          radial-gradient(1px 1px at 80% 30%, #fff, transparent),
          radial-gradient(2px 2px at 20% 70%, #fff, transparent);
        background-size: 300px 300px;
        opacity: 0.4;
        animation: rotacionEspacial 100s linear infinite;
        pointer-events: none;
    }

    .nebula-container {
        position: absolute;
        width: 100%; height: 100%;
        filter: blur(50px);
        mix-blend-mode: screen;
        pointer-events: none;
    }

    .aurora-hilo {
        position: absolute;
        width: 150%; height: 60%;
        top: 10%; left: -25%;
        background: repeating-linear-gradient(
          90deg, transparent, var(--c1) 5%, var(--c2) 15%, transparent 25%
        );
        mask-image: radial-gradient(ellipse at center, black, transparent 70%);
        -webkit-mask-image: radial-gradient(ellipse at center, black, transparent 70%);
        opacity: 0.6;
        animation: danzaHilos 20s ease-in-out infinite alternate;
        transition: background 1.5s ease;
    }

    .aurora-hilo.dos {
        top: 30%;
        background: repeating-linear-gradient(
          90deg, transparent, var(--c3) 10%, var(--c4) 20%, transparent 30%
        );
        animation-duration: 25s; animation-delay: -5s; opacity: 0.5;
    }

    @keyframes danzaHilos {
        0% { transform: skewX(-15deg) translateX(-5%) scaleY(1); filter: hue-rotate(0deg); }
        100% { transform: skewX(15deg) translateX(5%) scaleY(1.2); filter: hue-rotate(20deg); }
    }
    @keyframes rotacionEspacial { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Control de tiempo Marea */
    .time-toggles { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .time-toggle-btn { background: transparent; border: none; color: var(--text-dim); padding: 5px 15px; font-size: 0.9rem; cursor: pointer; position: relative; }
    .time-toggle-btn.active { color: var(--text-primary); font-weight: bold; }
    .time-toggle-btn.active::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--crimson-bright); }

    .oracle-text {
      font-family: 'Georgia', serif; font-size: 1.15rem; line-height: 1.6;
      color: var(--text-primary); text-align: center; margin: 0 auto 30px auto;
      max-width: 90%; font-style: italic; text-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* --- NUBE DE PALABRAS MEJORADA (FLEXBOX SIN SUPERPOSICI√ìN) --- */
    .cloud-container {
      position: relative; 
      width: 100%; 
      min-height: 220px;
      margin-top: 20px; 
      padding: 20px;
      border: 1px solid var(--glass-border);
      border-radius: 20px; 
      background: rgba(0,0,0,0.2);
      
      /* CLAVE: Usamos Flexbox con wrap para que no se encimen */
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-content: center;
      gap: 5px; 
    }
    
    .cloud-tag {
      position: relative; /* Ya no es absolute */
      font-size: 0.8rem; 
      padding: 6px 14px; 
      border-radius: 18px; 
      background: var(--glass);
      transition: all 0.3s ease; 
      cursor: default;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      
      /* Bordes suaves */
      border: 1px solid rgba(255,255,255,0.05);
      color: var(--text-dim);
    }
    
    .cloud-tag:hover {
        transform: scale(1.15) !important;
        z-index: 100;
        background: var(--crimson-dark);
        color: white;
        border-color: var(--crimson-glow);
        box-shadow: 0 0 15px var(--crimson-glow);
    }

  </style>
</head>
<body>

  <div id="splash" role="img" aria-label="Pantalla de bienvenida Crimson">
    <div class="lotus" aria-hidden="true">
      <div class="core"></div>
      <div class="petal" style="--i:0"></div>
      <div class="petal" style="--i:1"></div>
      <div class="petal" style="--i:2"></div>
      <div class="petal" style="--i:3"></div>
      <div class="petal" style="--i:4"></div>
      <div class="petal" style="--i:5"></div>
      <div class="petal" style="--i:6"></div>
      <div class="petal" style="--i:7"></div>
    </div>
    <div class="brand-name">Crimson</div>
  </div>

  <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg-gradient); z-index:10000; display:flex; align-items:center; justify-content:center;">
    <div id="auth-login" class="auth-card" style="text-align:center; background:var(--glass); padding:45px; border-radius:40px; border:1px solid var(--glass-border); width:85%; max-width:360px; backdrop-filter:blur(20px);">
      <h1 style="margin-bottom:30px;">CRIMSON</h1>
      <input aria-label="Usuario" type="text" id="log-user" placeholder="Usuario">
      <input aria-label="Contrase√±a" type="password" id="log-pass" placeholder="Contrase√±a">
      <button class="main-btn" onclick="handleLogin()" style="margin-top:10px;" aria-label="Entrar al diario">Entrar al Diario</button>
      <div style="margin-top:25px; font-size:0.85rem; opacity:0.6;">
        <span onclick="showAuth('auth-reg')" style="cursor:pointer">Unirse</span> | <span onclick="showAuth('auth-rec')" style="cursor:pointer">Recuperar</span>
      </div>
    </div>
    
    <div id="auth-reg" class="auth-card hidden" style="text-align:center; background:var(--glass); padding:35px; border-radius:40px; border:1px solid var(--glass-border); width:85%; max-width:360px;">
      <h2>Nuevo Inicio</h2>
      <input aria-label="Nuevo usuario" type="text" id="reg-user" placeholder="Usuario">
      <input aria-label="Nueva contrase√±a" type="password" id="reg-pass" placeholder="Contrase√±a">
      <select aria-label="Pregunta de recuperaci√≥n" id="reg-q"><option>¬øLugar favorito?</option><option>¬øTu mascota?</option></select>
      <input aria-label="Respuesta recuperaci√≥n" type="text" id="reg-a" placeholder="Respuesta">
      <button class="main-btn" onclick="handleRegister()">Registrar</button>
      <p onclick="showAuth('auth-login')" style="cursor:pointer; font-size:0.8rem; margin-top:15px;">Volver</p>
    </div>

    <div id="auth-rec" class="auth-card hidden" style="text-align:center; background:var(--glass); padding:35px; border-radius:40px; border:1px solid var(--glass-border); width:85%; max-width:360px;">
      <h2>Recuperar</h2>
      <input aria-label="Usuario para recuperar" type="text" id="rec-user" placeholder="Usuario" onblur="updateRecQuestion()">
      <p id="rec-q-text" style="font-size:0.8rem; color:var(--crimson-bright);"></p>
      <input aria-label="Respuesta recuperaci√≥n" type="text" id="rec-a" placeholder="Respuesta">
      <input aria-label="Nueva clave" type="password" id="rec-newpass" placeholder="Nueva Clave" class="hidden">
      <button class="main-btn" id="rec-btn" onclick="handleRecovery()">Verificar</button>
      <p onclick="showAuth('auth-login')" style="cursor:pointer; font-size:0.8rem; margin-top:15px;">Cancelar</p>
    </div>
  </div>

  <div class="container hidden" id="main-app" role="main">
    <header>
      <div>
        <h1 id="app-title">DIARIO</h1>
        <div id="fechaHoy" style="font-size:0.85rem; opacity:0.6; font-weight:300;"></div>
      </div>
      <button aria-label="Cambiar tema" class="theme-toggle" onclick="toggleTheme(this)" id="themeBtn">üåô</button>
    </header>

    <div style="display:flex; gap:15px; margin-bottom:25px;">
      <input aria-label="Buscar recuerdos" type="text" id="buscador" placeholder="Explorar recuerdos..." oninput="render()" style="margin-bottom:0">
      <button id="bulb-btn" aria-label="Sugerencia" onclick="getPrompt()" style="background:var(--glass); border:1px solid var(--glass-border); border-radius:20px; padding:0 18px; cursor:pointer;">üí°</button>
    </div>

    <div id="view-journal">
      <div class="filter-bar" id="cat-filters" style="display:flex; gap:12px; overflow-x:auto; padding-bottom:15px; scrollbar-width:none;">
        <div class="pill active" onclick="setCatFilter('Todos', event)">Todos</div>
        <div class="pill" onclick="setCatFilter('Pensamiento', event)">üí≠ Pensamiento</div>
        <div class="pill" onclick="setCatFilter('Objetivo', event)">üéØ Objetivo</div>
        <div class="pill" onclick="setCatFilter('Canci√≥n', event)">üéµ Canci√≥n</div>
        <div class="pill" onclick="setCatFilter('Regla', event)">üìú Regla</div>
        <div class="pill" onclick="setCatFilter('Libro', event)">üìö Libro</div>
      </div>

      <div class="composer" aria-label="Compositor de entradas">
        <div class="mood-bar" role="radiogroup" aria-label="Selector de estado de √°nimo">
          <span class="mood-icon active" role="radio" aria-checked="true" tabindex="0" onclick="setMood('calm', this)">‚ú®</span>
          <span class="mood-icon" role="radio" aria-checked="false" tabindex="0" onclick="setMood('happy', this)">üòä</span>
          <span class="mood-icon" role="radio" aria-checked="false" tabindex="0" onclick="setMood('love', this)">‚ù§Ô∏è</span>
          <span class="mood-icon" role="radio" aria-checked="false" tabindex="0" onclick="setMood('sad', this)">üò¢</span>
          <span class="mood-icon" role="radio" aria-checked="false" tabindex="0" onclick="setMood('angry', this)">üî•</span>
        </div>
        <textarea aria-label="Texto de la nota" id="note-text" placeholder="¬øC√≥mo te sientes hoy?" rows="4"></textarea>
        
        <div class="rec-box">
          <button id="audio-btn" aria-label="Grabar audio" class="rec-btn" onclick="toggleRecording()">üéôÔ∏è</button>
          <span id="rec-label" class="rec-label" style="display:none; color:var(--crimson-glow); font-size:0.8rem; font-weight:bold;">‚óè GRABANDO...</span>
          <span id="audio-status" style="font-size:0.75rem; opacity:0.6; margin-left:auto;">Nota de voz</span>
        </div>

        <input aria-label="Etiquetas" type="text" id="note-tags" placeholder="#etiquetas, momentos...">
        
        <div style="display:flex; gap:12px; align-items:center;">
          <select aria-label="Tipo de nota" id="note-type" style="flex:1;">
            <option>üí≠ Pensamiento</option>
            <option>üéØ Objetivo</option>
            <option>üéµ Canci√≥n</option>
            <option>üìú Regla</option>
            <option>üìö Libro</option>
          </select>
          <div style="flex:1; position:relative;">
            <input aria-label="Fecha de la nota" type="date" id="capsule-date" style="margin-bottom:14px; text-align:center; font-weight:bold;">
            <span onclick="setTodayDate()" style="position:absolute; right:10px; top:12px; font-size:0.7rem; background:var(--crimson-dark); padding:3px 8px; border-radius:5px; cursor:pointer;">Hoy</span>
          </div>
        </div>

        <button aria-label="Guardar nota" class="main-btn" id="saveBtn" onclick="saveNote()">Eternizar Registro</button>
        <button aria-label="Cancelar edici√≥n" class="main-btn hidden" id="cancelEditBtn" onclick="cancelEdit()" style="background:none; border:1px solid var(--crimson-bright); margin-top:10px; color:var(--crimson-bright);">Cancelar Edici√≥n</button>
      </div>

      <div style="display:flex; gap:15px; margin-bottom:20px;">
        <button class="pill active" id="tab-act" onclick="setTab('activos')">Vivos</button>
        <button class="pill" id="tab-pap" onclick="setTab('papelera')">Papelera</button>
      </div>
      <div id="journal-list" aria-live="polite"></div>
    </div>

    <div id="view-gallery" class="hidden" aria-label="Galer√≠a">
      <div class="composer">
        <input aria-label="Seleccionar imagen" type="file" id="img-file" accept="image/*" style="padding:12px">
        <input aria-label="Descripci√≥n imagen" type="text" id="img-caption" placeholder="Describe esta captura...">
        <div style="text-align:right; margin-bottom:10px;">
           <input aria-label="Fecha imagen" type="date" id="img-date-input" style="width:auto; display:inline-block;">
        </div>
        <button aria-label="Guardar imagen" class="main-btn" onclick="saveImage()">Guardar Imagen</button>
      </div>
      <div id="gallery-container" aria-live="polite"></div>
    </div>

    <div id="view-mapa" class="hidden" aria-label="La Marea">
      <h2 style="font-family:serif; letter-spacing:3px; margin-bottom:5px; text-align:center; opacity:0.9;">LA MAREA</h2>
      
      <div class="time-toggles">
          <button class="time-toggle-btn active" id="btn-week" onclick="setMareaTime('week')">Semana</button>
          <button class="time-toggle-btn" id="btn-month" onclick="setMareaTime('month')">Mes</button>
      </div>

      <div id="marea-visual-box">
         <div class="estrellas" aria-hidden="true"></div>
         <div class="nebula-container" aria-hidden="true">
            <div class="aurora-hilo"></div>
            <div class="aurora-hilo dos"></div>
         </div>
      </div>

      <div id="marea-insight" class="oracle-text">
          Escuchando el agua...
      </div>

      <div style="margin-top:20px;">
         <h3 style="font-size:0.7rem; letter-spacing:2px; opacity:0.4; text-align:center; text-transform:uppercase; margin-bottom:20px;">Ecos Recurrentes (Palabras)</h3>
         <div class="cloud-container" id="word-cloud" aria-live="polite"></div>
      </div>
    </div>

  </div>

  <nav class="bottom-nav hidden" id="nav-bar" role="navigation" aria-label="Navegaci√≥n inferior">
    <div class="nav-item active" id="nav-j" onclick="switchView('journal')"><span class="icon">üìú</span><span style="font-size:0.75rem">Diario</span></div>
    <div class="nav-item" id="nav-g" onclick="switchView('gallery')"><span class="icon">üñºÔ∏è</span><span style="font-size:0.75rem">Fotos</span></div>
    <div class="nav-item" id="nav-m" onclick="switchView('mapa')"><span class="icon">üåä</span><span style="font-size:0.75rem">Marea</span></div>
    <div class="nav-item" onclick="location.reload()"><span class="icon">üîí</span><span style="font-size:0.75rem">Salir</span></div>
  </nav>

  <div id="image-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:5000; display:none; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(15px); padding:20px;">
    <img id="modal-img" src="" alt="Imagen" style="max-width:100%; max-height:55vh; border-radius:25px; box-shadow:0 0 40px rgba(0,0,0,0.5); object-fit:contain;">
    <div id="modal-read-mode" style="width:100%; max-width:400px; text-align:center;">
      <p id="modal-caption" style="color:white; margin:20px 0 5px 0; font-size:1.1rem; text-align:center;"></p>
      <p id="modal-date" style="color:var(--crimson-bright); font-size:0.8rem; margin-bottom:20px;"></p>
      <div class="modal-btn-group">
         <button class="modal-btn btn-edit" onclick="toggleEditImgMode(true)">‚úèÔ∏è Editar</button>
         <button class="modal-btn btn-del" onclick="deleteCurrentImg()">üóëÔ∏è Borrar</button>
      </div>
      <button class="main-btn" onclick="closeModal()" style="width:auto; padding:12px 45px; background:#333; margin-top:20px;">Cerrar</button>
    </div>
    <div id="modal-edit-mode" class="hidden" style="width:100%; max-width:400px; margin-top:20px;">
      <input aria-label="Editar descripci√≥n imagen" type="text" id="edit-img-caption" placeholder="Nueva descripci√≥n">
      <input aria-label="Editar fecha imagen" type="date" id="edit-img-date">
      <div class="modal-btn-group">
        <button class="modal-btn btn-save" onclick="saveImgChanges()">üíæ Guardar</button>
        <button class="modal-btn btn-edit" onclick="toggleEditImgMode(false)">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // --- INICIALIZACI√ìN ---
    window.addEventListener("load", () => {
      const splash = document.getElementById("splash");
      setTimeout(() => { splash.classList.add("fade-out"); }, 3500); 
      setTodayDate(); 
      // Allow closing splash with Escape for accessibility
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') splash.classList.add('fade-out');
      });
    });

    // --- DATOS Y VARIABLES ---
    let db = JSON.parse(localStorage.getItem("crimson_vitality_v16")) || { users: {} };
    let currentUser = null, currentTab = 'activos', currentView = 'journal', editID = null;
    let selectedCat = 'Todos', selectedMood = 'calm', audioBlob = null, mediaRecorder = null, mediaStream = null;
    let mareaTimeFrame = 'week'; 
    let currentImgID = null;
    let editAudio = null; // preserve audio when editing a note

    const prompts = ["¬øQu√© libro te hizo pensar hoy?", "¬øCu√°l es tu meta m√°s ambiciosa?", "¬øQu√© emoci√≥n te define ahora?", "Escribe una regla que nunca romper√°s.", "¬øQu√© te quit√≥ el sue√±o anoche?", "¬øUn sonido que te traiga paz?"];
    const saveDB = () => localStorage.setItem("crimson_vitality_v16", JSON.stringify(db));

    // --- FECHA UTILIDAD ---
    function setTodayDate() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`;
      
      if(document.getElementById('capsule-date')) document.getElementById('capsule-date').value = today;
      if(document.getElementById('fechaHoy')) document.getElementById('fechaHoy').innerText = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
      if(document.getElementById('img-date-input')) document.getElementById('img-date-input').value = today;
    }

    // --- TEMAS CON ANIMACI√ìN DE MOVIMIENTO ---
    function toggleTheme(btn) {
      document.body.classList.toggle('light-mode');
      
      // A√±adir clase para rotaci√≥n
      btn.classList.add('spinning');
      
      // Cambiar icono despu√©s de la mitad de la animaci√≥n
      setTimeout(() => {
          btn.innerText = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
      }, 400);

      // Quitar clase para poder repetir
      setTimeout(() => {
          btn.classList.remove('spinning');
      }, 800);
    }

    // --- EMOCIONES ---
    function setMood(m, el) {
      selectedMood = m;
      document.querySelectorAll('.mood-icon').forEach(i => {
        i.classList.remove('active');
        i.setAttribute('aria-checked', 'false');
      });
      el.classList.add('active');
      el.setAttribute('aria-checked', 'true');
    }

    // --- AUTH ---
    function showAuth(id) { document.querySelectorAll('.auth-card').forEach(c => c.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function handleRegister() {
      const u = document.getElementById('reg-user').value.trim();
      const pass = document.getElementById('reg-pass').value;
      const q = document.getElementById('reg-q').value;
      const a = document.getElementById('reg-a').value.trim().toLowerCase();

      if(!u || !pass || !a) return alert("Completa todos los campos");
      if(db.users[u]) return alert("Usuario no disponible");

      // Initialize user structure defensively
      db.users[u] = { pass: pass, question: q, answer: a, notes: [], gallery: [] };
      saveDB(); showAuth('auth-login');
    }
    function handleLogin() {
      const u = document.getElementById('log-user').value.trim(), p = document.getElementById('log-pass').value;
      if(db.users[u] && db.users[u].pass === p) {
        currentUser = u; document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden'); document.getElementById('nav-bar').classList.remove('hidden'); render();
      } else alert("Error de acceso");
    }
    function updateRecQuestion() { const u = document.getElementById('rec-user').value.trim(); document.getElementById('rec-q-text').innerText = db.users[u]?.question || "No existe"; }
    function handleRecovery() {
       const u = document.getElementById('rec-user').value.trim(), a = document.getElementById('rec-a').value.trim().toLowerCase();
       if(document.getElementById('rec-btn').innerText === "Verificar") {
         if(db.users[u]?.answer === a) { document.getElementById('rec-newpass').classList.remove('hidden'); document.getElementById('rec-btn').innerText = "Cambiar Clave"; }
         else alert("Respuesta incorrecta");
       } else {
         if(!db.users[u]) return alert("Usuario no encontrado");
         db.users[u].pass = document.getElementById('rec-newpass').value; saveDB(); showAuth('auth-login');
       }
    }

    // --- AUDIO ---
    async function toggleRecording() {
      const btn = document.getElementById('audio-btn');
      const label = document.getElementById('rec-label');
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(mediaStream);
          let chunks = [];
          mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
            const r = new FileReader();
            r.onload = () => { audioBlob = r.result; document.getElementById('audio-status').innerText = "Voz lista ‚úÖ"; };
            r.readAsDataURL(blob);

            // Stop all tracks to free the microphone
            try {
              if (mediaStream && mediaStream.getTracks) {
                mediaStream.getTracks().forEach(t => t.stop());
              }
            } finally {
              mediaStream = null;
            }
          };
          mediaRecorder.start();
          btn.classList.add('recording'); label.style.display = 'inline';
        } catch(e) { alert("Micr√≥fono bloqueado o no disponible"); }
      } else {
        // Stop recorder, onstop handler will stop tracks
        mediaRecorder.stop();
        btn.classList.remove('recording'); label.style.display = 'none';
        // clear mediaRecorder reference after a short delay to allow onstop to run
        setTimeout(() => { mediaRecorder = null; }, 300);
      }
    }

    // --- CORE FUNCIONES ---
    function getPrompt() { document.getElementById('note-text').value = prompts[Math.floor(Math.random() * prompts.length)]; }

    function saveNote() {
      if(!currentUser || !db.users[currentUser]) return alert("Sesi√≥n inv√°lida. Vuelve a iniciar sesi√≥n.");
      const text = document.getElementById('note-text').value;
      const dateVal = document.getElementById('capsule-date').value || new Date().toISOString().split('T')[0];
      
      if(!text && !audioBlob && !editAudio) return alert("Escribe o graba algo.");

      const idValue = editID || (Date.now().toString() + Math.floor(Math.random()*1000).toString());
      const audioToSave = audioBlob || editAudio || null;

      const newNote = {
        id: idValue,
        text: text,
        mood: selectedMood,
        type: document.getElementById('note-type').value,
        tags: (document.getElementById('note-tags').value || '').split(',').map(t=>t.trim()).filter(t=>t),
        date: dateVal,
        audio: audioToSave,
        deleted: false
      };

      // Ensure user's notes array exists
      if(!Array.isArray(db.users[currentUser].notes)) db.users[currentUser].notes = [];

      if(editID) {
        const idx = db.users[currentUser].notes.findIndex(n => n.id === editID);
        if(idx !== -1) db.users[currentUser].notes[idx] = newNote;
        editID = null;
        editAudio = null;
        document.getElementById('saveBtn').innerText = "Eternizar Registro";
        document.getElementById('cancelEditBtn').classList.add('hidden');
      } else {
        db.users[currentUser].notes.push(newNote);
      }
      
      saveDB();
      document.getElementById('note-text').value = "";
      document.getElementById('note-tags').value = "";
      audioBlob = null; editAudio = null; document.getElementById('audio-status').innerText = "Nota de voz";
      
      render();
      alert("Guardado exitosamente.");
    }

    function editNote(id) {
      if(!currentUser || !db.users[currentUser]) return;
      const n = db.users[currentUser].notes.find(n => n.id === id);
      if(!n) return;
      document.getElementById('note-text').value = n.text || '';
      document.getElementById('note-tags').value = (n.tags || []).join(', ');
      document.getElementById('note-type').value = n.type || document.getElementById('note-type').options[0].value;
      document.getElementById('capsule-date').value = n.date || new Date().toISOString().split('T')[0];
      selectedMood = n.mood || 'calm';
      // Actualizar UI de mood
      document.querySelectorAll('.mood-icon').forEach(i => i.classList.remove('active'));
      const moodMap = {'calm':0, 'happy':1, 'love':2, 'sad':3, 'angry':4};
      const iconIndex = moodMap[n.mood] || 0;
      const icons = document.querySelectorAll('.mood-icon');
      if (icons[iconIndex]) icons[iconIndex].classList.add('active');
      
      editID = id;
      editAudio = n.audio || null; // preserve audio if any
      audioBlob = null; // if user records new audio it will overwrite
      document.getElementById('saveBtn').innerText = "Guardar Cambios";
      document.getElementById('cancelEditBtn').classList.remove('hidden');
      window.scrollTo(0,0);
    }

    function cancelEdit() {
      editID = null;
      editAudio = null;
      audioBlob = null;
      document.getElementById('saveBtn').innerText = "Eternizar Registro";
      document.getElementById('cancelEditBtn').classList.add('hidden');
      document.getElementById('note-text').value = "";
      document.getElementById('note-tags').value = "";
    }

    function deleteNote(id, perm = false) {
      if(!currentUser || !db.users[currentUser]) return;
      const idx = db.users[currentUser].notes.findIndex(n => n.id === id);
      if(idx === -1) return;
      if(perm) db.users[currentUser].notes.splice(idx, 1);
      else db.users[currentUser].notes[idx].deleted = true;
      saveDB(); render();
    }
    
    function restoreNote(id) {
      if(!currentUser || !db.users[currentUser]) return;
      const n = db.users[currentUser].notes.find(n => n.id === id);
      if(n) { n.deleted = false; saveDB(); render(); }
    }

    function setTab(t) {
      currentTab = t;
      document.getElementById('tab-act').classList.toggle('active', t==='activos');
      document.getElementById('tab-pap').classList.toggle('active', t==='papelera');
      render();
    }

    function setCatFilter(c, evt) {
      selectedCat = c;
      document.querySelectorAll('#cat-filters .pill').forEach(p => p.classList.remove('active'));
      if(evt && evt.currentTarget) evt.currentTarget.classList.add('active');
      else if(evt && evt.target) evt.target.classList.add('active');
      render();
    }

    // --- RENDERIZADO PRINCIPAL ---
    function render() {
      if(!currentUser || !db.users[currentUser]) return;
      renderJournal();
      if(currentView === 'gallery') renderGallery();
      if(currentView === 'mapa') renderMarea();
    }

    function renderJournal() {
      if(!currentUser || !db.users[currentUser]) return;
      const list = document.getElementById('journal-list');
      const search = (document.getElementById('buscador').value || '').toLowerCase();
      const notesArr = Array.isArray(db.users[currentUser].notes) ? db.users[currentUser].notes : [];
      
      const filtered = notesArr.filter(n => {
        const isDel = currentTab === 'papelera' ? n.deleted : !n.deleted;
        const matchCat = selectedCat === 'Todos' || (n.type && n.type.includes(selectedCat));
        const textLower = (n.text || '').toLowerCase();
        const matchSearch = textLower.includes(search) || (n.tags || []).some(t => t.toLowerCase().includes(search));
        return isDel && matchCat && matchSearch;
      }).sort((a,b) => new Date(b.date) - new Date(a.date));

      // Clear list
      list.innerHTML = '';
      if(filtered.length === 0) {
        const p = document.createElement('p');
        p.style.textAlign = 'center'; p.style.opacity = '0.5'; p.style.marginTop = '30px'; p.textContent = 'Vac√≠o...';
        list.appendChild(p);
        return;
      }

      filtered.forEach(n => {
        const card = document.createElement('div');
        card.className = 'note-card item';
        card.style.borderLeft = `4px solid ${getMoodColor(n.mood)}`;

        const header = document.createElement('div');
        header.className = 'note-header';
        const left = document.createElement('span');
        left.style.fontSize = '1.2rem';
        left.innerHTML = `${getMoodEmoji(n.mood)} <span style="font-size:0.8rem;opacity:0.7;margin-left:5px">${escapeHtml(n.type || '')}</span>`;
        const date = document.createElement('span');
        date.className = 'note-date';
        date.textContent = n.date || '';
        header.appendChild(left);
        header.appendChild(date);

        const para = document.createElement('p');
        para.style.whiteSpace = 'pre-wrap';
        para.style.lineHeight = '1.5';
        para.textContent = n.text || '';

        card.appendChild(header);
        card.appendChild(para);

        if(n.audio) {
          const audioEl = document.createElement('audio');
          audioEl.controls = true;
          audioEl.src = n.audio;
          audioEl.style.width = '100%';
          audioEl.style.marginTop = '10px';
          audioEl.style.opacity = '0.8';
          audioEl.style.height = '35px';
          card.appendChild(audioEl);
        }

        const tagContainer = document.createElement('div');
        tagContainer.className = 'note-tags';
        (n.tags || []).forEach(t => {
          const span = document.createElement('span');
          span.className = 'note-tag';
          span.textContent = `#${t}`;
          tagContainer.appendChild(span);
        });
        card.appendChild(tagContainer);

        const actions = document.createElement('div');
        actions.className = 'note-actions';

        if(currentTab === 'activos') {
          const editBtn = document.createElement('span');
          editBtn.className = 'action-icon';
          editBtn.style.cursor = 'pointer';
          editBtn.textContent = '‚úèÔ∏è';
          editBtn.addEventListener('click', () => editNote(n.id));
          const delBtn = document.createElement('span');
          delBtn.className = 'action-icon';
          delBtn.style.cursor = 'pointer';
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.addEventListener('click', () => {
            if(confirm('Mover a la papelera?')) deleteNote(n.id);
          });
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
        } else {
          const restoreBtn = document.createElement('span');
          restoreBtn.className = 'action-icon';
          restoreBtn.style.cursor = 'pointer';
          restoreBtn.textContent = '‚ôªÔ∏è';
          restoreBtn.addEventListener('click', () => restoreNote(n.id));
          const permBtn = document.createElement('span');
          permBtn.className = 'action-icon';
          permBtn.style.cursor = 'pointer';
          permBtn.textContent = '‚ùå';
          permBtn.addEventListener('click', () => {
            if(confirm('Eliminar permanentemente?')) deleteNote(n.id, true);
          });
          actions.appendChild(restoreBtn);
          actions.appendChild(permBtn);
        }

        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    function getMoodColor(m) {
      if(m==='happy') return '#ffd700'; if(m==='love') return '#ff69b4';
      if(m==='sad') return '#87ceeb'; if(m==='angry') return '#ff4500';
      return '#fff'; // calm
    }
    function getMoodEmoji(m) {
      if(m==='happy') return 'üòä'; if(m==='love') return '‚ù§Ô∏è';
      if(m==='sad') return 'üò¢'; if(m==='angry') return 'üî•';
      return '‚ú®'; 
    }

    // --- GALER√çA (MESES) ---
    function saveImage() {
       if(!currentUser || !db.users[currentUser]) return alert("Sesi√≥n inv√°lida.");
       const file = document.getElementById('img-file').files[0];
       const cap = document.getElementById('img-caption').value;
       const dateVal = document.getElementById('img-date-input').value || new Date().toISOString().split('T')[0];
       
       if(!file) return alert("Selecciona imagen");
       const reader = new FileReader();
       reader.onload = function(e) {
          if(!Array.isArray(db.users[currentUser].gallery)) db.users[currentUser].gallery = [];
          db.users[currentUser].gallery.push({
             id: Date.now().toString() + Math.floor(Math.random()*1000).toString(),
             src: e.target.result,
             caption: cap,
             date: dateVal
          });
          saveDB(); renderGallery();
          document.getElementById('img-file').value = "";
          document.getElementById('img-caption').value = "";
          alert("Imagen guardada");
       }
       reader.readAsDataURL(file);
    }

    function renderGallery() {
      if(!currentUser || !db.users[currentUser]) return;
      const container = document.getElementById('gallery-container');
      const images = Array.isArray(db.users[currentUser].gallery) ? db.users[currentUser].gallery : [];
      
      const groups = {};
      images.forEach(img => {
          let dStr = img.date || new Date().toISOString().split('T')[0];
          let monthKey = dStr.substring(0, 7); // "2024-01"
          if(!groups[monthKey]) groups[monthKey] = [];
          groups[monthKey].push(img);
      });

      const sortedKeys = Object.keys(groups).sort().reverse();

      container.innerHTML = '';
      if(sortedKeys.length === 0) {
          const p = document.createElement('p');
          p.style.textAlign = 'center'; p.style.opacity = '0.5'; p.style.marginTop = '30px';
          p.textContent = 'Sin recuerdos visuales...';
          container.appendChild(p);
          return;
      }

      sortedKeys.forEach(key => {
          const [y, m] = key.split('-');
          const dateObj = new Date(y, m - 1);
          const monthName = dateObj.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
          const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);

          groups[key].sort((a,b) => new Date(b.date) - new Date(a.date));

          const monthGroup = document.createElement('div');
          monthGroup.className = 'month-group';
          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = capitalizedMonth;
          const scroll = document.createElement('div');
          scroll.className = 'gallery-scroll';

          groups[key].forEach(img => {
            const card = document.createElement('div');
            card.className = 'gallery-card';
            card.addEventListener('click', () => openModal(img.id));

            const box = document.createElement('div');
            box.className = 'gallery-img-box';
            const image = document.createElement('img');
            image.src = img.src;
            image.alt = img.caption || 'Imagen';
            box.appendChild(image);

            const caption = document.createElement('div');
            caption.style.fontSize = '0.8rem';
            caption.style.whiteSpace = 'nowrap';
            caption.style.overflow = 'hidden';
            caption.style.textOverflow = 'ellipsis';
            caption.style.opacity = '0.8';
            caption.textContent = img.caption || 'Sin t√≠tulo';

            const dateLink = document.createElement('span');
            dateLink.className = 'date-link';
            dateLink.textContent = img.date || '';

            card.appendChild(box);
            card.appendChild(caption);
            card.appendChild(dateLink);
            scroll.appendChild(card);
          });

          monthGroup.appendChild(title);
          monthGroup.appendChild(scroll);
          container.appendChild(monthGroup);
      });
    }

    // Modal Galer√≠a Logic
    function openModal(id) {
       if(!currentUser || !db.users[currentUser]) return;
       const img = (db.users[currentUser].gallery || []).find(i => i.id === id);
       if(!img) return;
       currentImgID = id;
       document.getElementById('modal-img').src = img.src;
       document.getElementById('modal-caption').innerText = img.caption || "";
       document.getElementById('modal-date').innerText = img.date || "";
       
       document.getElementById('modal-read-mode').classList.remove('hidden');
       document.getElementById('modal-edit-mode').classList.add('hidden');
       
       document.getElementById('image-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
    
    function toggleEditImgMode(edit) {
        if(edit) {
            const img = (db.users[currentUser].gallery || []).find(i => i.id === currentImgID);
            if(!img) return;
            document.getElementById('edit-img-caption').value = img.caption || "";
            document.getElementById('edit-img-date').value = img.date || "";
            document.getElementById('modal-read-mode').classList.add('hidden');
            document.getElementById('modal-edit-mode').classList.remove('hidden');
        } else {
            document.getElementById('modal-read-mode').classList.remove('hidden');
            document.getElementById('modal-edit-mode').classList.add('hidden');
        }
    }
    
    function saveImgChanges() {
        if(!currentUser || !db.users[currentUser]) return;
        const idx = (db.users[currentUser].gallery || []).findIndex(i => i.id === currentImgID);
        if(idx !== -1) {
            db.users[currentUser].gallery[idx].caption = document.getElementById('edit-img-caption').value;
            db.users[currentUser].gallery[idx].date = document.getElementById('edit-img-date').value;
            saveDB();
            renderGallery();
            openModal(currentImgID);
        }
    }
    
    function deleteCurrentImg() {
        if(!currentUser || !db.users[currentUser]) return;
        if(confirm("¬øBorrar esta imagen?")) {
            const idx = (db.users[currentUser].gallery || []).findIndex(i => i.id === currentImgID);
            if(idx !== -1) {
              db.users[currentUser].gallery.splice(idx, 1);
              saveDB(); renderGallery(); closeModal();
            }
        }
    }

    // --- MAREA REINTEGRADA: REACCI√ìN A EMOCIONES + NUBE ---
    function setMareaTime(tf) {
      mareaTimeFrame = tf;
      document.getElementById('btn-week').classList.toggle('active', tf==='week');
      document.getElementById('btn-month').classList.toggle('active', tf==='month');
      renderMarea();
    }

    function renderMarea() {
      if(!currentUser || !db.users[currentUser]) return;
      // 1. Filtrar notas por tiempo
      const now = new Date();
      const notes = (db.users[currentUser].notes || []).filter(n => !n.deleted && n.text);
      let filteredNotes = [];

      if(mareaTimeFrame === 'week') {
         const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
         filteredNotes = notes.filter(n => {
           try { return new Date(n.date + 'T00:00:00') >= oneWeekAgo; } catch(e){ return false; }
         });
      } else {
         const oneMonthAgo = new Date(); oneMonthAgo.setMonth(now.getMonth() - 1);
         filteredNotes = notes.filter(n => {
           try { return new Date(n.date + 'T00:00:00') >= oneMonthAgo; } catch(e){ return false; }
         });
      }

      // --- 2. L√ìGICA DE REACTIVIDAD (CAMBIO DE COLORES) ---
      // Calculamos la emoci√≥n dominante en el periodo seleccionado
      let moodCounts = {};
      filteredNotes.forEach(n => moodCounts[n.mood] = (moodCounts[n.mood] || 0) + 1);
      
      // Encontrar emoci√≥n dominante (si no hay, 'calm')
      let dominantMood = 'calm';
      if (Object.keys(moodCounts).length > 0) {
        dominantMood = Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b);
      }
      
      // Mapa de colores por emoci√≥n (Aurora / Nebulosa)
      const moodColors = {
          'happy': ['rgba(255, 215, 0, 0.7)', 'rgba(255, 140, 0, 0.6)', 'rgba(255, 255, 0, 0.5)', 'rgba(255, 69, 0, 0.6)'], // Dorado/Naranja
          'love':  ['rgba(255, 20, 147, 0.7)', 'rgba(255, 105, 180, 0.6)', 'rgba(255, 182, 193, 0.5)', 'rgba(219, 112, 147, 0.6)'], // Rosa
          'sad':   ['rgba(30, 144, 255, 0.7)', 'rgba(0, 191, 255, 0.6)', 'rgba(135, 206, 250, 0.5)', 'rgba(70, 130, 180, 0.6)'], // Azul Profundo
          'angry': ['rgba(255, 0, 0, 0.7)', 'rgba(178, 34, 34, 0.6)', 'rgba(255, 69, 0, 0.5)', 'rgba(128, 0, 0, 0.6)'], // Rojo Intenso
          'calm':  ['rgba(0, 255, 180, 0.7)', 'rgba(0, 150, 255, 0.6)', 'rgba(180, 80, 255, 0.5)', 'rgba(50, 255, 50, 0.6)'] // Verde/Azul (Default)
      };

      const c = moodColors[dominantMood] || moodColors['calm'];
      
      // Actualizar variables CSS din√°micamente
      document.documentElement.style.setProperty('--c1', c[0]);
      document.documentElement.style.setProperty('--c2', c[1]);
      document.documentElement.style.setProperty('--c3', c[2]);
      document.documentElement.style.setProperty('--c4', c[3]);

      // --- 3. NUBE DE PALABRAS (FLEXBOX SIN SUPERPOSICI√ìN) ---
      const stopWords = ['el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'y', 'o', 'pero', 'si', 'no', 'en', 'de', 'del', 'a', 'al', 'por', 'para', 'con', 'sin', 'sobre', 'mi', 'tu', 'su', 'me', 'te', 'se', 'lo', 'le', 'que', 'qu√©', 'es', 'son', 'fue', 'era', 'estoy', 'estas', 'esta', 'est√°', 'hoy', 'ayer', 'ma√±ana', 'como', 'cuando', 'donde', 'porque', 'muy', 'm√°s', 'mas', 'todo', 'nada', 'eso', 'esto', 'ese', 'este'];

      let wordCounts = {};
      
      filteredNotes.forEach(n => {
          let cleanText = (n.text || '').toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()?"¬°!¬ø]/g,"");
          let words = cleanText.split(/\s+/);
          words.forEach(w => {
              if(w.length > 2 && !stopWords.includes(w)) {
                  wordCounts[w] = (wordCounts[w] || 0) + 1;
              }
          });
      });

      let sortedWords = Object.entries(wordCounts)
                              .sort((a,b) => b[1] - a[1])
                              .slice(0, 18); // Top 18 palabras

      const cloudBox = document.getElementById('word-cloud');
      cloudBox.innerHTML = '';
      
      if(sortedWords.length === 0) {
          const p = document.createElement('p');
          p.style.color = 'var(--text-dim)';
          p.style.textAlign = 'center';
          p.style.width = '100%';
          p.textContent = 'Silencio en las aguas...';
          cloudBox.appendChild(p);
      } else {
          // Generaci√≥n con m√°rgenes aleatorios para aspecto org√°nico pero sin choque
          sortedWords.forEach(item => {
              const w = item[0];
              const count = item[1];
              const size = 0.8 + (count * 0.15); 
              const mTop = Math.floor(Math.random() * 10);
              const mLeft = Math.floor(Math.random() * 10);

              const span = document.createElement('span');
              span.className = 'cloud-tag';
              span.style.fontSize = `${size}rem`;
              span.style.margin = `${mTop}px ${mLeft}px`;
              span.textContent = w;
              cloudBox.appendChild(span);
          });
      }

      const insights = [
          "El patr√≥n de tus d√≠as sugiere crecimiento.",
          "Las mareas traen recuerdos que sanan.",
          "Lo que escribes es el mapa de tu alma.",
          "Observa las palabras que m√°s repites, ah√≠ est√° tu foco."
      ];
      document.getElementById('marea-insight').innerText = insights[Math.floor(Math.random() * insights.length)];
    }

    function switchView(v) {
      currentView = v;
      document.getElementById('view-journal').classList.add('hidden');
      document.getElementById('view-gallery').classList.add('hidden');
      document.getElementById('view-mapa').classList.add('hidden');
      
      document.getElementById('view-' + v).classList.remove('hidden');
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(v === 'journal' ? 'nav-j' : v === 'gallery' ? 'nav-g' : 'nav-m').classList.add('active');
      
      render();
    }

    // --- UTILITIES ---
    function escapeHtml(unsafe) {
      if (unsafe === undefined || unsafe === null) return '';
      return String(unsafe).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        })[s];
      });
    }

  </script>
</body>
</html>
